# Local Path Provisioner - FORK README

- [Local Path Provisioner - FORK README](#local-path-provisioner---fork-readme)
  - [1. Why this fork ?](#1-why-this-fork-)
  - [2. HOW-TOs](#2-how-tos)
    - [2.1. Clone repo under Windows](#21-clone-repo-under-windows)
    - [2.2. Build and push the docker image](#22-build-and-push-the-docker-image)

## 1. Why this fork ?

With the base repo (v0.0.22), a PV generated from a PVC with a "Local Path Provisioner" storage class will always have a new generated name:
* PV name: `pvc-<GUID>`
* PV path: `<basePath>/pvc-<GUID>_<namespace>_<pvc-name>`

This fork adds an optional annotation `ahuh.fork/pv-dir-prefix` available on PVC with a "Local Path Provisioner" storage class. If present, the string value of the annotation will be used to generate a **predictable PV dir** for this PVC. This allows to keep persistent storage dirs, that may be reused between many deployments.

Example:
* PVC using a "Local Path Provisioner" storage class named `local-path`
  ```yaml
  apiVersion: v1
  kind: PersistentVolumeClaim
  metadata:
  name: my-volume-pvc
  namespace: my-namespace
  annotations:
  ahuh.fork/pv-dir-prefix: pv
  spec:
  accessModes:
  - ReadWriteOnce
  storageClassName: local-path
  resources:
  requests:
  storage: 128Mi
  ```

* The PV generated by this PVC will have these **predictable name and path** :
  * PV name: `pv-my-namespace-my-volume-pvc`
  * PV path: `<basePath>/pv_my-namespace-my_volume-pvc`

**WARNING: you are responsible for the uniqueness of the PV name**

TODO: add new env var 'VOL_PREDICTABLE_DIR' for script 'teardown', to prevent 'rm -rf' if set

## 2. HOW-TOs

### 2.1. Clone repo under Windows

* Clone the repository from github
* Under Windows, cloned files might have CRLF end-of-line sequences, inducing errors in scripts execution
* To solve the problem, run these commands in the repo dir, just after the `git clone` command:
  ```bash
  git config core.autocrlf input
  git rm --cached -r .
  git reset --hard
  git pull
  ```

### 2.2. Build and push the docker image

*Prerequisites*:
* Execute from bash under Linux or WSL2 bash under Windows
* Docker installed
* Internet connection available
* A git tag must be set on the branch to build (will be used to tag the docker image)
* The docker hub repo must already exist: in our case `ahuh/local-path-provisioner`

Build procedure:
```bash
# Install make (debian-based distros)
sudo apt install make

# Launch the make at the root of repo
# (replace 'ahuh' with the docker hub repo owner)
REPO=ahuh make
# => the docker image "ahuh/local-path-provisioner:<last-git-tag-name>-<arch>" is available:
#    - <last-git-tag-name> is the last tag on the git branch that has been built
#    - <arch> is automatically detected
```

Push procedure:
```bash
# Login as the docker hub user with credentials on the docker hub repo
docker login

# Push the docker image to docker hub
docker push ahuh/local-path-provisioner:<last-git-tag-name>-<arch>
```