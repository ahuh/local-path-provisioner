# Local Path Provisioner - FORK README

- [Local Path Provisioner - FORK README](#local-path-provisioner---fork-readme)
  - [1. Why this fork ?](#1-why-this-fork-)
  - [2. HOW-TOs](#2-how-tos)
    - [2.1. Clone repo under Windows](#21-clone-repo-under-windows)
    - [2.2. Build and push the docker image](#22-build-and-push-the-docker-image)

## 1. Why this fork ?

With the base repo (v0.0.22), a PV generated from a PVC with a "Local Path Provisioner" storage class will always have a new generated name:
* PV name: `pvc-<GUID>`
* PV path: `<basePath>/pvc-<GUID>_<namespace>_<pvc-name>`

This fork adds two optional annotations available on PVC with a "Local Path Provisioner" storage class:
*  `local-path-provisioner/ahuh-fork/pv-dir-prefix`: if present, the string value of the annotation will be used to generate a **predictable PV dir** for this PVC. This allows to keep persistent storage dirs, that may be reused between many deployments.
*  `local-path-provisioner/ahuh-fork/pv-dir-keep`: if present and equal to "true", should be used to prevent dir deletion in `teardown` script (to implement in the ConfigMap)

**WARNING: you are responsible for the uniqueness of the generated PV name**

Moreover, two new environment variables are available for scripts `setup` and `teardown`:

| Environment variable | Description |
|----------------------|-------------|
| VOL_DIR_PREFIX | Value of the annotation `local-path-provisioner/ahuh-fork/pv-dir-prefix` passed from the PVC to the current PV. *May* be used in scripts. |
| VOL_DIR_KEEP | Value of the annotation `local-path-provisioner/ahuh-fork/pv-dir-keep` passed from the PVC to the current PV. **Should** be used in scripts, in particular to prevent dir deletion at `teardown`. |

Example:
* PVC using a "Local Path Provisioner" storage class named `local-path`
  ```yaml
  apiVersion: v1
  kind: PersistentVolumeClaim
  metadata:
    name: my-volume-pvc
    namespace: my-namespace
    annotations:
      local-path-provisioner/ahuh-fork/pv-dir-prefix: "pv"
      local-path-provisioner/ahuh-fork/pv-dir-keep: "true"
  spec:
    accessModes:
    - ReadWriteOnce
    storageClassName: local-path
    resources:
      requests:
        storage: 128Mi
  ```

* The PV generated by this PVC will have these **predictable name and path** :
  * PV name: `pv-my-namespace-my-volume-pvc`
  * PV path: `<basePath>/pv_my-namespace-my_volume-pvc`

* Customized ConfigMap to use to implement conditional dir deletion in `teardown` script:
```yaml
kind: ConfigMap
apiVersion: v1
metadata:
  name: local-path-config
  namespace: local-path-storage
data:
  config.json: |-
        {
                "nodePathMap":[
                {
                        "node":"DEFAULT_PATH_FOR_NON_LISTED_NODES",
                        "paths":["/opt/local-path-provisioner"]
                },
                {
                        "node":"yasker-lp-dev1",
                        "paths":["/opt/local-path-provisioner", "/data1"]
                },
                {
                        "node":"yasker-lp-dev3",
                        "paths":[]
                }
                ]
        }
  setup: |-
        #!/bin/sh
        set -eu
        mkdir -m 0777 -p "$VOL_DIR"
  teardown: |-
        #!/bin/sh
        set -eu
        # Delete dir only if the dir keep annotation was not set on PVC / PV !
        [[ "$VOL_DIR_KEEP" != "true" ]] && rm -rf "$VOL_DIR"
  helperPod.yaml: |-
        apiVersion: v1
        kind: Pod
        metadata:
          name: helper-pod
        spec:
          containers:
          - name: helper-pod
            image: busybox
```

## 2. HOW-TOs

### 2.1. Clone repo under Windows

* Clone the repository from github
* Under Windows, cloned files might have CRLF end-of-line sequences, inducing errors in scripts execution
* To solve the problem, run these commands in the repo dir, just after the `git clone` command:
  ```bash
  git config core.autocrlf input
  git rm --cached -r .
  git reset --hard
  git pull
  ```

### 2.2. Build and push the docker image

*Prerequisites*:
* Execute from bash under Linux or WSL2 bash under Windows
* Docker installed
* Internet connection available
* A git tag must be set on the branch to build (will be used to tag the docker image)
* The docker hub repo must already exist: in our case `ahuh/local-path-provisioner`

Build procedure:
```bash
# Install make (debian-based distros)
sudo apt install make

# Launch the make at the root of repo
# (replace 'ahuh' with the docker hub repo owner)
REPO=ahuh make
# => the docker image "ahuh/local-path-provisioner:<last-git-tag-name>-<arch>" is available:
#    - <last-git-tag-name> is the last tag on the git branch that has been built
#    - <arch> is automatically detected
```

Push procedure:
```bash
# Login as the docker hub user with credentials on the docker hub repo
docker login

# Push the docker image to docker hub
docker push ahuh/local-path-provisioner:<last-git-tag-name>-<arch>
```